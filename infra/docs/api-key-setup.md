# Google Maps API Key Setup Guide

## Automatic API Key Creation

The Terraform configuration creates a restricted API key automatically:
- Restricted to Geocoding API only
- Stored in Secret Manager
- Accessible by the normalizer service account

## Setting Usage Limits (Manual Steps)

Since Terraform doesn't support API quota management, you need to set limits manually:

### 1. Access Google Cloud Console
```bash
# Open the API credentials page
gcloud alpha services api-keys list
# Or visit: https://console.cloud.google.com/apis/credentials
```

### 2. Set Quotas for Geocoding API
1. Go to [APIs & Services > Enabled APIs](https://console.cloud.google.com/apis/dashboard)
2. Click on "Geocoding API"
3. Click "Quotas & System Limits"
4. Set limits:
   - **Requests per day**: 2,500 (free tier)
   - **Requests per minute**: 50
   - **Requests per minute per user**: 10

### 3. Alternative: Use API Key Restrictions
Add these restrictions in the Terraform config:
- **Application restrictions**: None (for server use)
- **API restrictions**: Geocoding API only âœ“ (already set)
- **IP restrictions**: Add Cloud Run service IP (optional)

## Using the Auto-Generated Key

### For Cloud Run Deployment
Update the Makefile to use the auto-generated key:
```bash
# The deploy command should reference the auto-generated secret
--update-secrets GOOGLE_MAPS_API_KEY=google-maps-api-key-auto:latest
```

### For Local Testing
```bash
# Get the auto-generated API key
gcloud secrets versions access latest --secret="google-maps-api-key-auto"

# Add to your .env file
GOOGLE_MAPS_API_KEY=<auto-generated-key>
```

## Budget Alerts (Recommended)

Set up budget alerts to avoid unexpected charges:

```bash
# Create a budget via gcloud
gcloud billing budgets create \
  --billing-account=YOUR_BILLING_ACCOUNT_ID \
  --display-name="Maps API Budget" \
  --budget-amount=10 \
  --threshold-rule=percent=50 \
  --threshold-rule=percent=90 \
  --threshold-rule=percent=100
```

## Monitoring Usage

Check your API usage:
```bash
# View API metrics
gcloud monitoring metrics-descriptors list --filter="metric.type:maps"

# Or use the Console
# https://console.cloud.google.com/apis/api/geocoding-backend.googleapis.com/metrics
```